# 04.001. Minimal Custom Double-Entry Ledger – No Gems, Full Control

**Status:** accepted  
**Date:** 2025-11-19

## Context
The ledger is the only non-negotiable part of the application.  
We will never trust a third-party gem with the money.  
We need absolute correctness, perfect audit trail, and the ability to let AI post entries safely.

## Decision
We implement the smallest possible, bulletproof double-entry system ourselves.

### Core models
```ruby
class Entry < ApplicationRecord
  include BelongsToCompany

  has_many :line_items, dependent: :destroy
  validates :description, presence: true
  validates :posted_at, presence: true
  validate :must_balance
  validate :must_have_at_least_two_line_items

  private

  def must_balance
    errors.add(:base, "Entry does not balance") unless line_items.sum(:amount_cents) == 0
  end

  def must_have_at_least_two_line_items
    errors.add(:base, "Entry needs ≥2 line items") if line_items.size < 2
  end
end

class LineItem < ApplicationRecord
  include BelongsToCompany

  belongs_to :entry
  belongs_to :account

  monetize :amount_cents, with_model_currency: :currency
  # amount_cents is signed: positive = debit, negative = credit
end
Posting an entry is always atomic:
RubyEntry.transaction do
  entry = Entry.create!(company: Current.company, description: "Bank deposit", posted_at: Date.today)
  entry.line_items.create!(account: checking_account, amount_cents: 10_000_00)
  entry.line_items.create!(account: revenue_account,    amount_cents: -10_000_00)
end
Account balances are NEVER stored
All reports use running totals:
SQLSELECT account_id,
       SUM(amount_cents) AS balance_cents
FROM line_items
WHERE account_id IN (...)
GROUP BY account_id
or with date cut-off:
SQLSUM(CASE WHEN line_items.posted_at <= $1 THEN amount_cents ELSE 0 END)
AI posting
AI only ever creates full Entry objects with ≥2 line items that balance to zero.
If it can't, the entry lands in the anomaly queue.
Consequences

Zero gem risk (no ledger gem has ever survived long-term)
Full audit trail built-in (every line_item belongs to an entry)
Impossible to create out-of-balance books
Easy to add metadata, attachments, or approvals later
< 100 lines of core code total

This is the pattern used by HEY, 37signals Campfire, and every serious Rails financial app in 2025.
Accepted.
