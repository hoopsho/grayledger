# 02.001. Passwordless OTP via Email – Rails 8 Native, No Devise

**Status:** accepted  
**Date:** 2025-11-19

## Context
- Users hate passwords
- We want zero credential storage (no encrypted password column ever)
- We must support instant login from any device
- Rails 8 gives us everything we need out of the box

## Decision
Authentication flow:

1. User visits /login → enters only their email address
2. System generates a cryptographically-secure 6-digit OTP + 10-minute expiry
3. OTP is stored **hashed** in a new model `LoginToken` (not in cleartext)
4. Rails Action Mailer sends a one-time magic email:
   Subject: “Your LedgerAI login code: 392041”
   Body: plain text, big numbers, single “Log in” button that contains signed token
5. User types/pastes the 6 digits or clicks the button
6. We verify the hash, log them in via signed cookie session, delete the token

### Models
```ruby
# db/migrate/..._create_login_tokens.rb
create_table :login_tokens do |t|
  t.references :user, null: false, foreign_key: true
  t.string :hashed_token, null: false
  t.datetime :expires_at, null: false
  t.timestamps
end
add_index :login_tokens, :hashed_token, unique: true
Rubyclass LoginToken < ApplicationRecord
  belongs_to :user

  def self.generate_for(user)
    raw = SecureRandom.random_number(1_000_000).to_s.rjust(6, "0")
    hashed = Digest::SHA256.hexdigest(raw)
    create!(user: user, hashed_token: hashed, expires_at: 10.minutes.from_now)
    raw
  end

  def self.valid?(raw_token)
    hashed = Digest::SHA256.hexdigest(raw_token)
    token = find_by(hashed_token: hashed, expires_at: ..Time.current)
    token&.destroy
    token&.user
  end
end
Routes
Rubyget  "login", to: "sessions#new"
post "login", to: "sessions#create"
get  "login/:token", to: "sessions#magic" # for magic link click
No passwords column on users table ever
Consequences

Zero password reset flows
Phishing-resistant (OTP is single-use and short-lived)
Works perfectly on mobile (copy-paste or magic link)
No Devise, no bcrypt, no credential stuffing risk
Pure Rails 8 + Action Mailer + Active Record

This is the same pattern DHH uses on HEY and Basecamp in 2025.
Accepted.
