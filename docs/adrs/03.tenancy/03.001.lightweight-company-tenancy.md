# 03.001. Lightweight Row-Level Company Tenancy

**Status:** accepted  
**Date:** 2025-11-19

## Context
Every record in the system (accounts, transactions, invoices, receipts, etc.) belongs to exactly one Company (the tenant).  
We need iron-clad data isolation with zero performance penalty and zero gem bloat.

## Decision
Pure row-level tenancy using a company_id foreign key on every tenant-scoped table + a Current attribute in the request lifecycle.

### Core patterns

```ruby
# app/models/company.rb
class Company < ApplicationRecord
  has_many :memberships, dependent: :destroy
  has_many :users, through: :memberships
  has_many :accounts, dependent: :destroy
  has_many :transactions, dependent: :destroy
  # … every other tenant model
end
```

```ruby
# app/models/concerns/belongs_to_company.rb
module BelongsToCompany
  extend ActiveSupport::Concern

  included do
    belongs_to :company
    validates :company, presence: true

    default_scope { where(company: Current.company) }
  end
end
```

Every tenant model (Account, Transaction, Invoice, Receipt, FixedAsset, etc.):

```ruby
class Transaction < ApplicationRecord
  include BelongsToCompany
  # …
end
```

### Request lifecycle
```ruby
# app/controllers/application_controller.rb
class ApplicationController < ActionController::Base
  set_current_tenant_through_filter
  before_action :require_company!

  def require_company!
    Current.company = current_user.memberships.find_by(id: params[:company_id])&.company
    redirect_to companies_path, alert: "Select a company" unless Current.company
  end
end
```

### Current attributes (Rails 8 native)
```ruby
# app/models/current.rb
class Current < ActiveSupport::CurrentAttributes
  attribute :user, :company
  resets { Time.zone = "UTC" }
end
```

**No gems, no acts_as_tenant, no apartment, no subdomain nonsense.**

## Consequences

- 100% data isolation guaranteed by foreign keys + default_scope
- Zero query leaks possible
- Zero performance cost (indexes on `company_id` everywhere)
- Switching companies = change a dropdown → new session value
- Platform god-mode can temporarily override `Current.company`

This is the simplest, fastest, most bulletproof tenancy possible in 2025.
