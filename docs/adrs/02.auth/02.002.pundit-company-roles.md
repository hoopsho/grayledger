# 02.002. Pundit + Company-Specific Roles

**Status:** accepted  
**Date:** 2025-11-19

## Context
- A User can belong to many Companies (owner, bookkeeper, employee, etc.)
- Permissions are always scoped to the current Company
- We need simple, explicit, auditable authorization
- Platform staff (us) need occasional god-mode access

## Decision
Use Pundit with a tiny twist:

### Models
```ruby
class Membership < ApplicationRecord
  belongs_to :user
  belongs_to :company

  enum role: {
    owner: 0,
    admin: 1,
    bookkeeper: 2,
    viewer: 3
  }
end
```

### Current context
We never use `current_user`. We always use:

```ruby
# app/controllers/application_controller.rb
before_action :set_current_company

def current_membership
  @current_membership ||= current_user.memberships.find_by(company: @current_company)
end

def current_role
  current_membership&.role || "none"
end
```

### Policies
Every policy receives both user and record, but we also pass the current_company:

```ruby
class TransactionPolicy < ApplicationPolicy
  def update?
    current_role.in?(%w[owner admin bookkeeper])
  end

  def destroy?
    current_role == "owner"
  end

  private

  def current_role
    user.memberships.find_by(company: record.company)&.role || "viewer"
  end
end
```

### ApplicationPolicy base class
```ruby
class ApplicationPolicy
  attr_reader :user, :record, :current_company

  def initialize(user, record, current_company: Current.company)
    @user = user
    @record = record
    @current_company = current_company
  end
end
```

### Platform superuser override
```ruby
# in every policy
def owner_or_platform_staff?
  current_role == "owner" || Current.platform_staff?
end
```

`Current.platform_staff?` is true only when the logged-in `user.email` ends with `@grayledger.io` (or is in a hard-coded list for now).

## Consequences

- No complex role gems
- Every permission is a one-line boolean in a policy file
- Scoping is automatic because every record `belongs_to :company`
- Platform can jump into any company in emergencies without invitation

Pure Rails way, zero magic, easy to reason about forever.
