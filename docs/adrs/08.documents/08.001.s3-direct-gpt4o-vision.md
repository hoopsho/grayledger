# 08.001. S3 Direct Upload + GPT-4o Vision – Receipts & PDFs Become Ledger Entries Instantly

**Status:** accepted  
**Date:** 2025-11-19

## Context
Users have shoeboxes of receipts, Amazon settlement PDFs, supplier invoices, loan documents.  
Manually typing them is the #1 reason they fall behind and hire expensive bookkeepers.

## Decision
Every file the user drags or photographs instantly becomes a perfect ledger entry.

### Flow (zero friction)
1. User drags file or snaps photo → Active Storage direct upload to S3 (no server bandwidth)
2. `after_create_commit` callback fires → `DocumentProcessorJob` (Solid Queue)
3. Job sends public S3 URL to GPT-4o Vision with prompt:
   > “This is a receipt/invoice/Amazon settlement/loan note. Extract vendor, date, total, tax, line items if any, and suggest ledger accounts from our 30-parent chart.”
4. GPT-4o returns structured JSON
5. System creates:
   - Entry + LineItems (balanced)
   - Attaches original file to the Entry
   - Confidence ≥ 0.95 → auto-post
   - < 0.95 → Anomaly Queue with preview (“Home Depot $487.12 – AI thinks Supplies”)

### Supported documents day one
- Receipts (photos or PDFs)
- Invoices from suppliers
- Amazon settlement PDFs (full parse – revenue, fees, refunds, reimbursements)
- Bank statements (fallback CSV
- Promissory notes / loan docs (for auto asset + loan setup)

### Active Storage config (Rails 8 native)
```yaml
# config/storage.yml
amazon:
  service: S3
  access_key_id: <%= ENV["AWS_ACCESS_KEY_ID"] %>
  secret_access_key: <%= ENV["AWS_SECRET_ACCESS_KEY"] %>
  region: us-east-1
  bucket: ledger-ai-production
  upload:
    server_side_encryption: AES256
    cache_control: "public, max-age=31536000"
```

Direct upload via Stimulus + Uppy or Hotwire file field → zero Ruby memory usage.

## Consequences

- Users go from "I'm 6 months behind" to "I'm always current" in one weekend
- Average receipt processed in < 4 seconds end-to-end
- Cost ≈ $0.015 per receipt (GPT-4o Vision) → drops to <$0.001 with vector cache
- No third-party OCR service, no Expensify, no extra logins
- Every penny is traced to a scanned document → audit heaven

This single feature makes the entire subscription feel free.
