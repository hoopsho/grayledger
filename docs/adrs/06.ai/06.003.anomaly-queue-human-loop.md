# 06.003. Anomaly Queue – Mandatory Human-in-the-Loop for < 95% Confidence

**Status:** accepted
**Date:** 2025-11-19

## Context
Even with pgvector memory + GPT-4o, there will always be ~1–3% of transactions that are legitimately weird, ambiguous, fraudulent, or completely new.
Die-hard bookkeepers are right: AI alone cannot be trusted 100% of the time with money.

## Decision
Every AI decision gets a confidence score (0.00–1.00).
Anything < 0.95 goes into a mandatory Anomaly Queue that the user (or their bookkeeper) must review.

### Confidence calculation
```ruby
def confidence_score
  return 0.999 if vector_match && similarity >= 0.94
  ai_response.dig("confidence") || 0.0
end
```

### Rules for auto-post vs queue

| Confidence | Vector Cache Hit | Action                                    |
|------------|------------------|-------------------------------------------|
| ≥ 0.95     | Yes or No        | Auto-post instantly                       |
| 0.80–0.94  | Yes              | Auto-post (but flag for optional review)  |
| < 0.80     | Any              | Anomaly Queue – human required            |

### Anomaly Queue UI (Turbo + Stimulus)

- Dashboard tab "Review (7)"
- Table with one-click buttons: **Approve · Edit · Split · Ignore · Flag Fraud**
- Bulk "Approve All High-Confidence" button
- Explanation column: "AI thinks Office Expense (92%) but we've seen this Home Depot pattern 47 times"

### Human override feeds back
Every human correction:

1. Creates the correct Entry
2. Updates/replaces the pgvector embedding
3. Next identical transaction will be 0.999 confidence forever

### Platform staff escalation
If a transaction is flagged "Flag Fraud", it also emails platform staff instantly.

## Consequences

- Users feel in control ("the robot asks me when it's unsure")
- Bookkeepers love us because their job shrinks to 5 minutes/month instead of 50 hours
- Zero silent wrong postings
- Audit trail shows every human touch
- We can truthfully say "nothing posts without 95%+ confidence or your explicit approval"

This is the feature that turns skeptics into evangelists.
