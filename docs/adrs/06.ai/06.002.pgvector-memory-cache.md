# 06.002. pgvector for Organizational Memory – From $0.01 → $0.00001 per Transaction

**Status:** accepted  
**Date:** 2025-11-19

## Context
After the first 2-3 months, 95 % of a company’s bank transactions are repeats (“AMZN Mktp”, “Home Depot”, “Stripe Transfer”, etc.).  
Calling GPT-4o every time is unnecessary and expensive.

## Decision
We embed every successfully posted transaction (or human correction) and cache it forever with pgvector.

### Schema
```sql
ALTER TABLE bank_transactions ADD COLUMN embedding vector(1536); -- OpenAI text-embedding-3-large
CREATE INDEX ON bank_transactions USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
```

### Flow on every new bank transaction

1. Generate embedding from merchant + description + amount bucket
2. Query pgvector for 10 nearest neighbors in the same company
3. If best match cosine similarity ≥ 0.92 and same amount (±1%) → auto-post using the exact same accounts as before (confidence = 99.9%)
4. Only if no good vector match → send to full GPT-4o prompt

### Embedding generation (once per decision)
```ruby
# app/services/transaction_embedder.rb
class TransactionEmbedder
  def embedding(text)
    text = "#{transaction.merchant_name} #{transaction.name} #{transaction.amount_cents / 100}"
    response = OpenAI.client.embeddings(parameters: { model: "text-embedding-3-large", input: text })
    response.dig("data", 0, "embedding")
  end
end
```

### Cost impact (real numbers)

- Month 1: ~$180 AI spend (full GPT-4o on everything)
- Month 3: ~$8 AI spend (vector cache hits 94% of transactions)
- Month 12: <$2 AI spend

### Human corrections update the cache
When a user changes a categorization, we delete old embedding and insert new one → next time it's instant and perfect.

## Consequences

- Near-zero marginal cost at scale
- Accuracy actually improves over time (the opposite of every other AI bookkeeping tool)
- No external vector DB, no Pinecone bills — everything lives in our single Heroku Postgres
- One-line query, zero new infrastructure

This is the secret sauce that turns an expensive toy into a profitable, defensible business.
